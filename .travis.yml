sudo: required
dist: trusty
notifications:
  email:
    recipients:
      - hatohol-commit@lists.sourceforge.net
language: cpp
compiler:
  - gcc
  - clang
env:
  global:
    - MLPL_LOGGER_LEVEL=WARN
    - NO_MAKE=yes
    - TEST_AMQP_URL="amqp://test_user:test_password@localhost:5673/test"
  matrix:
    - RUN_TEST="test/run-server-test-misc.sh"
matrix:
  include:
    - compiler: gcc
      env: RUN_TEST="test/run-server-test-core.sh ^test[A-C]"
    - compiler: gcc
      env: RUN_TEST="test/run-server-test-core.sh ^test[D]"
    - compiler: gcc
      env: RUN_TEST="test/run-server-test-core.sh ^test[E-H]"
    - compiler: gcc
      env: RUN_TEST="test/run-server-test-core.sh ^test[^A-H]"
    - compiler: gcc
      env: RUN_TEST="test/dist-check.sh"
    - compiler: gcc
      env: RUN_TEST="test/run-client-test.sh"
    - compiler: gcc
      env: RUN_TEST="test/feature-test.sh"

# To prune non-root Python from PATH.
# see: https://github.com/travis-ci/travis-ci/issues/5326
before_install:
  - export PATH=$(echo $PATH | tr ':' "\n" | sed '/\/opt\/python/d' | tr "\n" ":" | sed "s|::|:|g")

install:
  - server/misc/setup-cutter.sh
  - sudo apt-get install -qq -y autotools-dev libglib2.0-dev libjson-glib-dev libsoup2.4-dev libmysqlclient-dev sqlite3 ndoutils-nagios3-mysql uuid-dev npm python-pip expect python-dev rabbitmq-server python-mysqldb python-pika librabbitmq-dev
  - sudo sh -c "printf '[%s]\n%s=%s\n' mysqld character-set-server utf8  > /etc/mysql/conf.d/utf8.cnf"
  - sudo sh -c "printf '[%s]\n%s=%s\n' client default-character-set utf8  >> /etc/mysql/conf.d/utf8.cnf"
  - mysql -u root < data/test/setup.sql
  - travis_retry npm install
  - sudo pip install django==1.6.11
  - sudo pip install daemon
  - sudo pip install python-mk-livestatus
  - sudo server/misc/setup-rabbitmq-server-port.sh
  - sudo service rabbitmq-server restart
before_script:
  - ./autogen.sh
  - ./configure
  - make
  - sudo chmod +r /var/log/syslog
  - sudo chmod 777 /var/run
script:
  - echo $RUN_TEST; eval "$RUN_TEST"
